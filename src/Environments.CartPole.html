<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-2"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- Module    :  Environments.CartPole</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- Copyright :  (c) Sentenai 2017</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- License   :  Proprietary</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Maintainer:  sam@sentenai.com</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Stability :  experimental</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Portability: non-portable</span><span>
</span><a name="line-9"></a><span class="hs-comment">--</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- * CartPole by Sutton et al.</span><span>
</span><a name="line-11"></a><span class="hs-comment">--</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Taken from https://webdocs.cs.ualberta.ca/~sutton/book/code/pole.c</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- with some added insights from the OpenAI gym</span><span>
</span><a name="line-14"></a><span class="hs-comment">--</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- cart_and_pole: the cart and pole dynamics; given action and current state,</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- estimates next state</span><span>
</span><a name="line-17"></a><span class="hs-comment">--</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- cart_pole:  Takes an action (0 or 1) and the current values of the</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- four state variables and updates their values by estimating the state</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- TAU seconds later.</span><span>
</span><a name="line-21"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-22"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><a name="line-23"></a><span class="hs-pragma">{-# LANGUAGE InstanceSigs #-}</span><span>
</span><a name="line-24"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><a name="line-25"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-26"></a><span class="hs-pragma">{-# LANGUAGE DeriveFunctor #-}</span><span>
</span><a name="line-27"></a><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><a name="line-28"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Environments</span><span class="hs-operator">.</span><span class="hs-identifier">CartPole</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Environments.CartPole.html#Environment"><span class="hs-identifier hs-type">Environment</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Environments.CartPole.html#runEnvironmentWithSeed"><span class="hs-identifier hs-var">runEnvironmentWithSeed</span></a><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Environments.CartPole.html#runEnvironmentWithSeed_"><span class="hs-identifier hs-var">runEnvironmentWithSeed_</span></a><span>
</span><a name="line-32"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Environments.CartPole.html#runEnvironment"><span class="hs-identifier hs-var">runEnvironment</span></a><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Environments.CartPole.html#runEnvironment_"><span class="hs-identifier hs-var">runEnvironment_</span></a><span>
</span><a name="line-34"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Logger.html#Event"><span class="hs-identifier hs-type">Logger</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Event</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.CartPole.html#Action"><span class="hs-identifier hs-type">Action</span></a><span>
</span><a name="line-36"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.CartPole.html#StateCP"><span class="hs-identifier hs-type">StateCP</span></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="Control.MonadEnv.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">MonadEnv</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="Control.MonadMWCRandom.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">MonadMWCRandom</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">DList</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Random</span><span class="hs-operator">.</span><span class="hs-identifier">MWC</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">MWC</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="Reinforce.Prelude.html"><span class="hs-identifier">Reinforce</span><span class="hs-operator">.</span><span class="hs-identifier">Prelude</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="Data.CartPole.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">CartPole</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Data.Logger.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Logger</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Logger</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">-- | A cartpole environment</span><span>
</span><a name="line-50"></a><span class="hs-keyword">newtype</span><span> </span><a name="Environment"><a href="Environments.CartPole.html#Environment"><span class="hs-identifier">Environment</span></a></a><span> </span><a name="local-6989586621679138835"><a href="#local-6989586621679138835"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Environment"><a href="Environments.CartPole.html#Environment"><span class="hs-identifier">Environment</span></a></a><span>
</span><a name="line-51"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="getEnvironment"><a href="Environments.CartPole.html#getEnvironment"><span class="hs-identifier">getEnvironment</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RWST</span><span> </span><a href="Environments.CartPole.html#CartPoleConf"><span class="hs-identifier hs-type">CartPoleConf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DList</span><span> </span><a href="Data.CartPole.html#Event"><span class="hs-identifier hs-type">Event</span></a><span class="hs-special">)</span><span> </span><a href="Environments.CartPole.html#CartPoleState"><span class="hs-identifier hs-type">CartPoleState</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679138835"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-52"></a><span>  </span><span class="hs-keyword">deriving</span><span>
</span><a name="line-53"></a><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Functor</span><span>
</span><a name="line-54"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span>
</span><a name="line-56"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span>
</span><a name="line-57"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span>
</span><a name="line-58"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadReader</span><span> </span><a href="Environments.CartPole.html#CartPoleConf"><span class="hs-identifier hs-type">CartPoleConf</span></a><span>
</span><a name="line-59"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadWriter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DList</span><span> </span><a href="Data.CartPole.html#Event"><span class="hs-identifier hs-type">Event</span></a><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadState</span><span> </span><a href="Environments.CartPole.html#CartPoleState"><span class="hs-identifier hs-type">CartPoleState</span></a><span>
</span><a name="line-61"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadRWS</span><span> </span><a href="Environments.CartPole.html#CartPoleConf"><span class="hs-identifier hs-type">CartPoleConf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DList</span><span> </span><a href="Data.CartPole.html#Event"><span class="hs-identifier hs-type">Event</span></a><span class="hs-special">)</span><span> </span><a href="Environments.CartPole.html#CartPoleState"><span class="hs-identifier hs-type">CartPoleState</span></a><span>
</span><a name="line-62"></a><span>    </span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-comment">-- | run an environment with an explicit seed</span><span>
</span><a name="line-65"></a><span class="hs-identifier">runEnvironmentWithSeed</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Environments.CartPole.html#Environment"><span class="hs-identifier hs-type">Environment</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GenIO</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DList</span><span> </span><a href="Data.CartPole.html#Event"><span class="hs-identifier hs-type">Event</span></a><span class="hs-special">)</span><span>
</span><a name="line-66"></a><a name="runEnvironmentWithSeed"><a href="Environments.CartPole.html#runEnvironmentWithSeed"><span class="hs-identifier">runEnvironmentWithSeed</span></a></a><span> </span><span class="hs-special">(</span><a href="Environments.CartPole.html#Environment"><span class="hs-identifier hs-var">Environment</span></a><span> </span><a name="local-6989586621679138837"><a href="#local-6989586621679138837"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679138838"><a href="#local-6989586621679138838"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-67"></a><span>  </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">evalRWST</span><span> </span><a href="#local-6989586621679138837"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><a href="Environments.CartPole.html#cartPoleConf"><span class="hs-identifier hs-var">cartPoleConf</span></a><span> </span><a href="#local-6989586621679138838"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span> </span><a href="Environments.CartPole.html#initialCartPoleState"><span class="hs-identifier hs-var">initialCartPoleState</span></a><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">-- | same as 'runEnvironmentWithSeed' but don't return history</span><span>
</span><a name="line-70"></a><span class="hs-identifier">runEnvironmentWithSeed_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Environments.CartPole.html#Environment"><span class="hs-identifier hs-type">Environment</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GenIO</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><a name="runEnvironmentWithSeed_"><a href="Environments.CartPole.html#runEnvironmentWithSeed_"><span class="hs-identifier">runEnvironmentWithSeed_</span></a></a><span> </span><a name="local-6989586621679138839"><a href="#local-6989586621679138839"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679138840"><a href="#local-6989586621679138840"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Environments.CartPole.html#runEnvironmentWithSeed"><span class="hs-identifier hs-var">runEnvironmentWithSeed</span></a><span> </span><a href="#local-6989586621679138839"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679138840"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-comment">-- | run an environment and create a new random generator for each effectful action</span><span>
</span><a name="line-74"></a><span class="hs-identifier">runEnvironment</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Environments.CartPole.html#Environment"><span class="hs-identifier hs-type">Environment</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DList</span><span> </span><a href="Data.CartPole.html#Event"><span class="hs-identifier hs-type">Event</span></a><span class="hs-special">)</span><span>
</span><a name="line-75"></a><a name="runEnvironment"><a href="Environments.CartPole.html#runEnvironment"><span class="hs-identifier">runEnvironment</span></a></a><span> </span><a name="local-6989586621679138841"><a href="#local-6989586621679138841"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MWC</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">createSystemRandom</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="Environments.CartPole.html#runEnvironmentWithSeed"><span class="hs-identifier hs-var">runEnvironmentWithSeed</span></a><span> </span><a href="#local-6989586621679138841"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-comment">-- | same as 'runEnvironment' but don't return history</span><span>
</span><a name="line-78"></a><span class="hs-identifier">runEnvironment_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Environments.CartPole.html#Environment"><span class="hs-identifier hs-type">Environment</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><a name="runEnvironment_"><a href="Environments.CartPole.html#runEnvironment_"><span class="hs-identifier">runEnvironment_</span></a></a><span> </span><a name="local-6989586621679138842"><a href="#local-6989586621679138842"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Environments.CartPole.html#runEnvironment"><span class="hs-identifier hs-var">runEnvironment</span></a><span> </span><a href="#local-6989586621679138842"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-keyword">data</span><span> </span><a name="CartPoleConf"><a href="Environments.CartPole.html#CartPoleConf"><span class="hs-identifier">CartPoleConf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CartPoleConf"><a href="Environments.CartPole.html#CartPoleConf"><span class="hs-identifier">CartPoleConf</span></a></a><span>
</span><a name="line-83"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="gravity"><a href="Environments.CartPole.html#gravity"><span class="hs-identifier">gravity</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Float</span><span>
</span><a name="line-84"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="masscart"><a href="Environments.CartPole.html#masscart"><span class="hs-identifier">masscart</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Float</span><span>
</span><a name="line-85"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="masspole"><a href="Environments.CartPole.html#masspole"><span class="hs-identifier">masspole</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Float</span><span>
</span><a name="line-86"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="poleLength"><a href="Environments.CartPole.html#poleLength"><span class="hs-identifier">poleLength</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Float</span><span> </span><span class="hs-comment">-- ^ actually half the pole's length</span><span>
</span><a name="line-87"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="forceMag"><a href="Environments.CartPole.html#forceMag"><span class="hs-identifier">forceMag</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Float</span><span>
</span><a name="line-88"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="tau"><a href="Environments.CartPole.html#tau"><span class="hs-identifier">tau</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Float</span><span> </span><span class="hs-comment">-- ^ seconds between state updates</span><span>
</span><a name="line-89"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="gen"><a href="Environments.CartPole.html#gen"><span class="hs-identifier">gen</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GenIO</span><span>
</span><a name="line-90"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-keyword">data</span><span> </span><a name="CartPoleState"><a href="Environments.CartPole.html#CartPoleState"><span class="hs-identifier">CartPoleState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CartPoleState"><a href="Environments.CartPole.html#CartPoleState"><span class="hs-identifier">CartPoleState</span></a></a><span>
</span><a name="line-93"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="epNum"><a href="Environments.CartPole.html#epNum"><span class="hs-identifier">epNum</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integer</span><span>
</span><a name="line-94"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="done"><a href="Environments.CartPole.html#done"><span class="hs-identifier">done</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-95"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="current"><a href="Environments.CartPole.html#current"><span class="hs-identifier">current</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><a href="Data.CartPole.html#StateCP"><span class="hs-identifier hs-type">StateCP</span></a><span>
</span><a name="line-96"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="stepsBeyondDone"><a href="Environments.CartPole.html#stepsBeyondDone"><span class="hs-identifier">stepsBeyondDone</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-97"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-identifier">polemassLength</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Environments.CartPole.html#CartPoleConf"><span class="hs-identifier hs-type">CartPoleConf</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Float</span><span>
</span><a name="line-100"></a><a name="polemassLength"><a href="Environments.CartPole.html#polemassLength"><span class="hs-identifier">polemassLength</span></a></a><span> </span><a name="local-6989586621679138843"><a href="#local-6989586621679138843"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">masspole</span><span> </span><a href="#local-6989586621679138843"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier">poleLength</span><span> </span><a href="#local-6989586621679138843"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-identifier">totalMass</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Environments.CartPole.html#CartPoleConf"><span class="hs-identifier hs-type">CartPoleConf</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Float</span><span>
</span><a name="line-103"></a><a name="totalMass"><a href="Environments.CartPole.html#totalMass"><span class="hs-identifier">totalMass</span></a></a><span> </span><a name="local-6989586621679138844"><a href="#local-6989586621679138844"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">masspole</span><span> </span><a href="#local-6989586621679138844"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier">masscart</span><span> </span><a href="#local-6989586621679138844"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-identifier">cartPoleConf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GenIO</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Environments.CartPole.html#CartPoleConf"><span class="hs-identifier hs-type">CartPoleConf</span></a><span>
</span><a name="line-106"></a><a name="cartPoleConf"><a href="Environments.CartPole.html#cartPoleConf"><span class="hs-identifier">cartPoleConf</span></a></a><span> </span><a name="local-6989586621679138845"><a href="#local-6989586621679138845"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Environments.CartPole.html#CartPoleConf"><span class="hs-identifier hs-var">CartPoleConf</span></a><span>
</span><a name="line-107"></a><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">gravity</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">9.8</span><span>
</span><a name="line-108"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">masscart</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1.0</span><span>
</span><a name="line-109"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">masspole</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0.1</span><span>
</span><a name="line-110"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">poleLength</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0.5</span><span>
</span><a name="line-111"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">forceMag</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">10.0</span><span>
</span><a name="line-112"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tau</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0.02</span><span>
</span><a name="line-113"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">gen</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679138845"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-114"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span class="hs-identifier">initialCartPoleState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Environments.CartPole.html#CartPoleState"><span class="hs-identifier hs-type">CartPoleState</span></a><span>
</span><a name="line-117"></a><a name="initialCartPoleState"><a href="Environments.CartPole.html#initialCartPoleState"><span class="hs-identifier">initialCartPoleState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Environments.CartPole.html#CartPoleState"><span class="hs-identifier hs-var">CartPoleState</span></a><span>
</span><a name="line-118"></a><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">epNum</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-119"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">done</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-120"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">current</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.CartPole.html#StateCP"><span class="hs-identifier hs-var">StateCP</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-121"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">stepsBeyondDone</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-122"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-comment">-- | Angle at which to fail the episode</span><span>
</span><a name="line-126"></a><span class="hs-identifier">thetaThresholdRadians</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Float</span><span>
</span><a name="line-127"></a><a name="thetaThresholdRadians"><a href="Environments.CartPole.html#thetaThresholdRadians"><span class="hs-identifier">thetaThresholdRadians</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">12</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">pi</span><span> </span><span class="hs-operator hs-var">/</span><span> </span><span class="hs-number">360</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-identifier">xThreshold</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Float</span><span>
</span><a name="line-131"></a><a name="xThreshold"><a href="Environments.CartPole.html#xThreshold"><span class="hs-identifier">xThreshold</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2.4</span><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-identifier">hasFallen</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.CartPole.html#StateCP"><span class="hs-identifier hs-type">StateCP</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-135"></a><a name="hasFallen"><a href="Environments.CartPole.html#hasFallen"><span class="hs-identifier">hasFallen</span></a></a><span> </span><a name="local-6989586621679138846"><a href="#local-6989586621679138846"><span class="hs-identifier">s</span></a></a><span>
</span><a name="line-136"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier">position</span><span> </span><a href="#local-6989586621679138846"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="Environments.CartPole.html#xThreshold"><span class="hs-identifier hs-var">xThreshold</span></a><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">position</span><span> </span><a href="#local-6989586621679138846"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="Environments.CartPole.html#xThreshold"><span class="hs-identifier hs-var">xThreshold</span></a><span>
</span><a name="line-138"></a><span>  </span><span class="hs-operator hs-var">||</span><span>    </span><span class="hs-identifier">angle</span><span> </span><a href="#local-6989586621679138846"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="Environments.CartPole.html#thetaThresholdRadians"><span class="hs-identifier hs-var">thetaThresholdRadians</span></a><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span>  </span><span class="hs-operator hs-var">||</span><span>    </span><span class="hs-identifier">angle</span><span> </span><a href="#local-6989586621679138846"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="Environments.CartPole.html#thetaThresholdRadians"><span class="hs-identifier hs-var">thetaThresholdRadians</span></a><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-comment">-- Angle limit set to 2 * thetaThresholdRadians so failing observation is still within bounds</span><span>
</span><a name="line-143"></a><span class="hs-comment">{-
high :: StateCP
high = StateCP
  { position  = xThreshold * 2
  , angle     = thetaThresholdRadians * 2
  , velocity  = 500 -- maxBound
  , angleRate = 500 -- maxBound
  }
-}</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-keyword">instance</span><span> </span><a href="Control.MonadMWCRandom.html#MonadMWCRandom"><span class="hs-identifier hs-type">MonadMWCRandom</span></a><span> </span><a href="Environments.CartPole.html#Environment"><span class="hs-identifier hs-type">Environment</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-155"></a><span>  </span><a name="local-8214565720323894493"><a href="Control.MonadMWCRandom.html#getGen"><span class="hs-identifier">getGen</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Environments.CartPole.html#Environment"><span class="hs-identifier hs-var">Environment</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">gen</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-identifier">uniformRandStateCP</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679138836"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Control.MonadMWCRandom.html#MonadMWCRandom"><span class="hs-identifier hs-type">MonadMWCRandom</span></a><span> </span><a href="#local-6989586621679138836"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679138836"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Data.CartPole.html#StateCP"><span class="hs-identifier hs-type">StateCP</span></a><span>
</span><a name="line-159"></a><a name="uniformRandStateCP"><a href="Environments.CartPole.html#uniformRandStateCP"><span class="hs-identifier">uniformRandStateCP</span></a></a><span>
</span><a name="line-160"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.CartPole.html#StateCP"><span class="hs-identifier hs-var">StateCP</span></a><span>
</span><a name="line-161"></a><span>  </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Control.MonadMWCRandom.html#uniformR"><span class="hs-identifier hs-var">uniformR</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">0.05</span><span class="hs-special">,</span><span> </span><span class="hs-number">0.05</span><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>  </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="Control.MonadMWCRandom.html#uniformR"><span class="hs-identifier hs-var">uniformR</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">0.05</span><span class="hs-special">,</span><span> </span><span class="hs-number">0.05</span><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>  </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="Control.MonadMWCRandom.html#uniformR"><span class="hs-identifier hs-var">uniformR</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">0.05</span><span class="hs-special">,</span><span> </span><span class="hs-number">0.05</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>  </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="Control.MonadMWCRandom.html#uniformR"><span class="hs-identifier hs-var">uniformR</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">0.05</span><span class="hs-special">,</span><span> </span><span class="hs-number">0.05</span><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-keyword">instance</span><span> </span><a href="Control.MonadEnv.html#MonadEnv"><span class="hs-identifier hs-type">MonadEnv</span></a><span> </span><a href="Environments.CartPole.html#Environment"><span class="hs-identifier hs-type">Environment</span></a><span> </span><a href="Data.CartPole.html#StateCP"><span class="hs-identifier hs-type">StateCP</span></a><span> </span><a href="Data.CartPole.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="Control.MonadEnv.html#Reward"><span class="hs-identifier hs-type">Reward</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-168"></a><span>  </span><span class="hs-identifier">reset</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Environments.CartPole.html#Environment"><span class="hs-identifier hs-type">Environment</span></a><span> </span><span class="hs-special">(</span><a href="Control.MonadEnv.html#Initial"><span class="hs-identifier hs-type">Initial</span></a><span> </span><a href="Data.CartPole.html#StateCP"><span class="hs-identifier hs-type">StateCP</span></a><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>  </span><a name="local-8214565720323884370"><a href="Control.MonadEnv.html#reset"><span class="hs-identifier">reset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-170"></a><span>    </span><a name="local-6989586621679138847"><a href="#local-6989586621679138847"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Environments.CartPole.html#uniformRandStateCP"><span class="hs-identifier hs-var">uniformRandStateCP</span></a><span>
</span><a name="line-171"></a><span>    </span><a href="Environments.CartPole.html#CartPoleState"><span class="hs-identifier hs-var">CartPoleState</span></a><span> </span><a name="local-6989586621679138848"><a href="#local-6989586621679138848"><span class="hs-identifier">epN</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679138849"><a href="#local-6989586621679138849"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">get</span><span>
</span><a name="line-172"></a><span>    </span><span class="hs-identifier hs-var">put</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Environments.CartPole.html#CartPoleState"><span class="hs-identifier hs-var">CartPoleState</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679138848"><span class="hs-identifier hs-var">epN</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621679138847"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621679138849"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-173"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Control.MonadEnv.html#Initial"><span class="hs-identifier hs-var">Initial</span></a><span> </span><a href="#local-6989586621679138847"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span>  </span><span class="hs-identifier">step</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.CartPole.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Environments.CartPole.html#Environment"><span class="hs-identifier hs-type">Environment</span></a><span> </span><span class="hs-special">(</span><a href="Control.MonadEnv.html#Obs"><span class="hs-identifier hs-type">Obs</span></a><span> </span><a href="Control.MonadEnv.html#Reward"><span class="hs-identifier hs-type">Reward</span></a><span> </span><a href="Data.CartPole.html#StateCP"><span class="hs-identifier hs-type">StateCP</span></a><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>  </span><a name="local-8214565720323884371"><a href="Control.MonadEnv.html#step"><span class="hs-identifier">step</span></a></a><span> </span><a name="local-6989586621679138850"><a href="#local-6989586621679138850"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-177"></a><span>    </span><a name="local-6989586621679138993"><a href="#local-6989586621679138993"><span class="hs-identifier">conf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-178"></a><span>    </span><a href="Environments.CartPole.html#CartPoleState"><span class="hs-identifier hs-var">CartPoleState</span></a><span> </span><a name="local-6989586621679138994"><a href="#local-6989586621679138994"><span class="hs-identifier">epN</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679138995"><a href="#local-6989586621679138995"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679138996"><a href="#local-6989586621679138996"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">get</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679138997"><a href="#local-6989586621679138997"><span class="hs-identifier">x</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">position</span><span> </span><a href="#local-6989586621679138995"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-181"></a><span>        </span><a name="local-6989586621679138998"><a href="#local-6989586621679138998"><span class="hs-identifier">xDot</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">velocity</span><span> </span><a href="#local-6989586621679138995"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-182"></a><span>        </span><a name="local-6989586621679138999"><a href="#local-6989586621679138999"><span class="hs-identifier">theta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">angle</span><span>    </span><a href="#local-6989586621679138995"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-183"></a><span>        </span><a name="local-6989586621679139000"><a href="#local-6989586621679139000"><span class="hs-identifier">thetaDot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">angleRate</span><span> </span><a href="#local-6989586621679138995"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679139001"><a href="#local-6989586621679139001"><span class="hs-identifier">force</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679138850"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Data.CartPole.html#GoLeft"><span class="hs-identifier hs-var">GoLeft</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier">forceMag</span><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">conf</span></a><span>
</span><a name="line-186"></a><span>        </span><a name="local-6989586621679139002"><a href="#local-6989586621679139002"><span class="hs-identifier">costheta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cos</span><span> </span><a href="#local-6989586621679138999"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-187"></a><span>        </span><a name="local-6989586621679139003"><a href="#local-6989586621679139003"><span class="hs-identifier">sintheta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sin</span><span> </span><a href="#local-6989586621679138999"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679139004"><a href="#local-6989586621679139004"><span class="hs-identifier">temp</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679139001"><span class="hs-identifier hs-var">force</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="Environments.CartPole.html#polemassLength"><span class="hs-identifier hs-var">polemassLength</span></a><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">conf</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679139000"><span class="hs-identifier hs-var">thetaDot</span></a><span> </span><span class="hs-operator hs-var">**</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679139003"><span class="hs-identifier hs-var">sintheta</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">/</span><span> </span><a href="Environments.CartPole.html#totalMass"><span class="hs-identifier hs-var">totalMass</span></a><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">conf</span></a><span>
</span><a name="line-190"></a><span>        </span><a name="local-6989586621679139005"><a href="#local-6989586621679139005"><span class="hs-identifier">thetaacc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">gravity</span><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">conf</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679139003"><span class="hs-identifier hs-var">sintheta</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679139002"><span class="hs-identifier hs-var">costheta</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679139004"><span class="hs-identifier hs-var">temp</span></a><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>                   </span><span class="hs-operator hs-var">/</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">poleLength</span><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">conf</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-special">(</span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">/</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">masspole</span><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">conf</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679139002"><span class="hs-identifier hs-var">costheta</span></a><span> </span><span class="hs-operator hs-var">**</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">/</span><span> </span><a href="Environments.CartPole.html#totalMass"><span class="hs-identifier hs-var">totalMass</span></a><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">conf</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>        </span><a name="local-6989586621679139006"><a href="#local-6989586621679139006"><span class="hs-identifier">xacc</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679139004"><span class="hs-identifier hs-var">temp</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="Environments.CartPole.html#polemassLength"><span class="hs-identifier hs-var">polemassLength</span></a><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">conf</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679139005"><span class="hs-identifier hs-var">thetaacc</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679139002"><span class="hs-identifier hs-var">costheta</span></a><span> </span><span class="hs-operator hs-var">/</span><span> </span><a href="Environments.CartPole.html#totalMass"><span class="hs-identifier hs-var">totalMass</span></a><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">conf</span></a><span>
</span><a name="line-193"></a><span>
</span><a name="line-194"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679139007"><a href="#local-6989586621679139007"><span class="hs-identifier">next</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.CartPole.html#StateCP"><span class="hs-identifier hs-var">StateCP</span></a><span>
</span><a name="line-195"></a><span>          </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">position</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679138997"><span class="hs-identifier hs-var">x</span></a><span>        </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier">tau</span><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">conf</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679138998"><span class="hs-identifier hs-var">xDot</span></a><span>
</span><a name="line-196"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">velocity</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679138998"><span class="hs-identifier hs-var">xDot</span></a><span>     </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier">tau</span><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">conf</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679139006"><span class="hs-identifier hs-var">xacc</span></a><span>
</span><a name="line-197"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">angle</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679138999"><span class="hs-identifier hs-var">theta</span></a><span>    </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier">tau</span><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">conf</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679139000"><span class="hs-identifier hs-var">thetaDot</span></a><span>
</span><a name="line-198"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">angleRate</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679139000"><span class="hs-identifier hs-var">thetaDot</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier">tau</span><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">conf</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679139005"><span class="hs-identifier hs-var">thetaacc</span></a><span>
</span><a name="line-199"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679139008"><a href="#local-6989586621679139008"><span class="hs-identifier">fallen</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Environments.CartPole.html#hasFallen"><span class="hs-identifier hs-var">hasFallen</span></a><span> </span><a href="#local-6989586621679139007"><span class="hs-identifier hs-var">next</span></a><span>
</span><a name="line-202"></a><span>        </span><a name="local-6989586621679139009"><a href="#local-6989586621679139009"><span class="hs-identifier">putNextState</span></a></a><span> </span><a name="local-6989586621679139010"><a href="#local-6989586621679139010"><span class="hs-identifier">ss</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-203"></a><span>          </span><span class="hs-identifier hs-var">put</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Environments.CartPole.html#CartPoleState"><span class="hs-identifier hs-var">CartPoleState</span></a><span> </span><a href="#local-6989586621679138994"><span class="hs-identifier hs-var">epN</span></a><span> </span><a href="#local-6989586621679139008"><span class="hs-identifier hs-var">fallen</span></a><span> </span><a href="#local-6989586621679139007"><span class="hs-identifier hs-var">next</span></a><span> </span><a href="#local-6989586621679139010"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-204"></a><span>          </span><span class="hs-identifier hs-var">tell</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Logger.html#Event"><span class="hs-identifier hs-var">Logger</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Event</span></a><span> </span><a href="#local-6989586621679138994"><span class="hs-identifier hs-var">epN</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromEnum</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679139010"><span class="hs-identifier hs-var">ss</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679138995"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621679138850"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679139008"><span class="hs-identifier hs-var">fallen</span></a><span>
</span><a name="line-207"></a><span>    </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679139009"><span class="hs-identifier hs-var">putNextState</span></a><span> </span><a href="#local-6989586621679138996"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Control.MonadEnv.html#Next"><span class="hs-identifier hs-var">Next</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621679139007"><span class="hs-identifier hs-var">next</span></a><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679138996"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-209"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>            </span><a href="#local-6989586621679139009"><span class="hs-identifier hs-var">putNextState</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>     </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Control.MonadEnv.html#Done"><span class="hs-identifier hs-var">Done</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- pole just fell!</span><span>
</span><a name="line-210"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138851"><span class="hs-identifier hs-var">warning</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="#local-6989586621679139009"><span class="hs-identifier hs-var">putNextState</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>     </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Control.MonadEnv.html#Done"><span class="hs-identifier hs-var">Done</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679139011"><a href="#local-6989586621679139011"><span class="hs-identifier">nsteps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679139009"><span class="hs-identifier hs-var">putNextState</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679139011"><span class="hs-identifier hs-var">nsteps</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Control.MonadEnv.html#Done"><span class="hs-identifier hs-var">Done</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-214"></a><span>      </span><span class="hs-identifier">warning</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679138852"><span class="hs-identifier hs-type">io</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679138852"><span class="hs-identifier hs-type">io</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>      </span><a name="local-6989586621679138851"><a href="#local-6989586621679138851"><span class="hs-identifier">warning</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">print</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-216"></a><span>        </span><span class="hs-string">&quot;You are calling step even though this environment has already returned done = True.&quot;</span><span>
</span><a name="line-217"></a><span>        </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;You should always call 'reset()' once you receive 'done = True' -- any further steps are undefined behavior.&quot;</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a></pre></body></html>